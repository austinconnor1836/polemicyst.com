version: "3.8"

services:
  backend:
    build: ./backend
    ports:
      - '3001:3001'
    volumes:
      - ./backend/uploads:/app/uploads
      - ./shared:/app/shared  # ⬅️ add this so backend can access shared prisma client

  poller:
    build:
      context: ./backend
      dockerfile: worker.Dockerfile
    command: ["node", "dist/workers/runPollFeeds.js"]
    volumes:
      - ./shared:/app/shared  # ⬅️ needed for prisma and shared code
    depends_on:
      - backend
      - redis
    environment:
      - NODE_ENV=production
      - DATABASE_URL=your-database-url-here  # ⬅️ you need this
    restart: unless-stopped

  redis:
    image: redis:6
    ports:
      - "6379:6379"
    restart: unless-stopped

  faster-whisper:
    image: lscr.io/linuxserver/faster-whisper:latest
    container_name: faster-whisper
    environment:
      - TZ=Etc/UTC
      - WHISPER_MODEL=tiny-int8
      - WHISPER_LANG=en
    volumes:
      - ./faster-whisper-data:/config
    ports:
      - '10300:10300'
    restart: unless-stopped

  ollama:
    build:
      context: ./backend
      dockerfile: ollama.Dockerfile
    container_name: ollama
    volumes:
      - ./backend/scripts/start-ollama.sh:/start.sh
      - ollama-data:/root/.ollama
    entrypoint: ["/bin/bash", "/start.sh"]
    ports:
      - "11434:11434"
    restart: unless-stopped

volumes:
  ollama-data:
